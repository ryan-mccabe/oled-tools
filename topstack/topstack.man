.TH TOPSTACK 8
.SH NAME
topstack \- Collect the kernel stack trace, and other diagnostic data, for processes using CPU cycles.
.SH SYNOPSIS
\fB topstack \fR
[\fB\-h\fR|\fB--help\fR]
[\fB--max-space\fR=\fIMAX_SPACE\fR]
[\fB--add\fR=\fIADDITIONAL\fR]
[\fB--pp\fR=\fIPIDFILES\fR]
[\fB--pstack\fR]
[\fB--trace\fR]
[\fB-c \fICPU\fR]
[\fB-s \fISYS\fR]
[\fB-u \fIUSR\fR]
[\fB-e \fISECONDS\fR]
[\fB-b\fR
[\fB-d \fIDIRECTORY\fR]
[\fB-t \fIMINUTES\fR]
[\fB--hs\fR=\fIHARDSTOP\fR]
[\fB-m \fIMAX_SIZE\fR]
[\fB-n \fINUMBER_OF_FILES\fR]]
[\fB-p\fR
[\fB-f \fIPERF_FILES\fR]
[\fB-r\fR]]

.SH DESCRIPTION
\fBtopstack\fR is used to gather the kernel stack trace for processes that are consuming CPU cycles.  The tool will sample proceses consuming CPU for \fISECONDS\fR and display any whose average utilization meets the criteria specified by \fB-c\fR, \fB-s\fR, or \fB-u\fR.  When a process meets the criteria, its stack trace is printed out.  The number of stack traces printed depends on the sample time \fB-e\fR.  Within the sample time, the cycle to collect the stack traces is every other second plus the time it takes to gather the stack (and optionally pstack).  If you specify \fB-e 10\fR, then you will get 5 or less stack traces per process.

If \fB-c \fICPU\fR is specified, then the processes that are displayed will have an average CPU utilization of \fICPU\fR or greater.

If \fB-s \fISYS\fR is specified, then the processes that are displayed will have an average SYS utilization of \fISYS\fR or greater.

If \fB-u \fIUSR\fR is specified, then the processes that are displayed will have an average USR utilization of \fIUSR\fR or greater.

These options can all be combined to create the exact filter you need.

By default, \fBtopstack\fR is run in the foreground with the output going to stdout.  However, it can be run in the background, gathering data over a period of time, and writing output to /var/oled/topstack/topstack_HOSTNAME.out.  To run in the background specify the \fB-b\fR option.  There are options that are specific to background mode, please see \fBBACKGROUND OPTIONS\fR.

The tool can gather more than just the kernel stack traces for the selected processes.  To gather \fBperf(1)\fR data specify the \fB-p\fR option.  See \fBPERF OPTIONS\fR.  If you specify --pstack, then /proc/PID/pstack will also be collected per process per cycle.  The \fB--pp\fR=\fIPIDFILES\fR option is used to gather the output from /proc/PID/* files.  For example, to collect /proc/PID/status for all the processes that match the criteria you would specify \fB--pp=status\fR.  \fB--pp\fR=\fIPIDFILES\fR can be specified more than once.  Lastly, you can gather the contents of other files on the system by using the \fB--add\fR=\fIADDITIONAL\fR option.  As an example you can specify \fB--add=/proc/buddyinfo\fR and /proc/buddyinfo will be included in the output.  This option can also be specified more than once.

Because the tool can be run in the background for a long period of time, a filesystem utilization check is included.  If the target filesystem is over 85% used, the tool will not run.  This can be changed using the \fB--max-space\fR option.
.SH OPTIONS
.TP
\fB\-h\fR,\fB--help\fR
Display help information.
.TP
\fB--max-space\fR=\fIMAX_SPACE\fR
Maximum disk space percentage used on log directory.  This defaults to 85.
.TP
\fB--add\fR=\fIADDITIONAL\fR
Additional files to be added to the output file.  Can be specified more than once.
.TP
\fB--pp\fR=\fIPIDFILES\fR
Additional file(s) (contents) to be added to the output file. Will dump the files from /proc/<PID>/<PIDFILE> where PID are the offending PIDs. Can be specified more than once.
.TP
\fB--pstack\fR
Captures /proc/PID/pstack per PID that meets the criteria.
.TP
\fB--trace\fR
Set logging level to trace.  Useful only for debugging the tool.
.SH UTILIZATION OPTIONS
.TP
\fB\-c \fICPU\fR
The threshold of % CPU utilization. If the process is at or above this threshold, the stack(s) will be dumped. The default value is 90.
.TP
\fB\-s \fISYS\fR
The threshold of % system utilization. If the process is at or above this threshold, the stack(s) will be dumped. The default value is 0.
.TP
\fB\-u \fIUSR\fR
The threshold of % user utilization. If the process is at or above this threshold, the stack(s) will be dumped. The default value is 0.
.TP
\fB\-e \fISECONDS\fR
The amount of time to sample for matching processes.  The default is 30 seconds.  If you specify \fB-e 10\fR, the processes will be sampled for 10 seconds.  The processes that will be displayed are those that match the critera specified, as averaged over 10 seconds.
.SH BACKGROUND OPTIONS
.TP
\fB-b\fR
Places topstack in background mode.  Data will be written to /var/oled/topstack/topstack_HOSTNAME.out.
.TP
\fB-d \fIDIRECTORY\fR
Specify the output directory other than the default /var/oled/topstack.
.TP
\fB-t \fIMINUTES\fR
The number of minutes that topstack should run when in background mode. The default is 30.
.TP
\fB--hs\fR=\fIHARDSTOP\fR
Hard stop, specified in minutes.  The topstack process will end this many minutes after printing the first process matching the threshold.  This is useful to ensure that data doesn't get overwritten.
.TP
\fB-m \fIMAX_SIZE\fR
The number maximum file size (MB) of the output file when in background mode. The default is 1Mb.
.TP
\fB-n \fINUMBER_OF_FILES\fR
How many files to retain when in background mode. The default is 5.
.SH PERF OPTIONS
.TP
\fB-p\fR
Runs the perf command if any process meets the criteria.
.TP
\fB-f \fIPERF_FILES\fR
Number of perf.data files to keep.  Default is 10.
.TP
\fB-r\fR
Create the perf report using the existing perf data files on the log directory.  Don't forget to specify \fB-d\fR if you used it when gathering the data.
.SH ASSUMPTIONS
\fBtopstack\fR must be run by root.
.SH EXAMPLES
.TP
To dump the stack traces of all processes that are >= 50% CPU utilization (for 30 seconds).
\fBtopstack -c 50\fR
.TP
To dump the stack traces of all processes that are >= 90% CPU utilization and include /proc/buddyinfo, /proc/pagetypeinfo, and /proc/zoneinfo in the output.
\fBtopstack --add=/proc/buddyinfo --add=/proc/pagetypeinfo --add=/proc/zoneinfo\fR
.SH REPORTING BUGS
.TP
Please contact Oracle Linux Support to report any bugs for OLED tools.
.SH SEE ALSO
.TP
oled kstack
